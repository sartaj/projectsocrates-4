"use strict";function textSelect(a,b,c){if(c=c||b,a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveEnd("character",c),d.moveStart("character",b),d.select()}else a.setSelectionRange&&(a.focus(),a.setSelectionRange(b,c))}angular.module("symbolMapApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("symbolMapApp").controller("MainCtrl",["$scope","$rootScope","symFlatModelConstructor","storage",function(a,b,c,d){b.workspace=[],b.symbols=d.get(),c.applyWorkspace(),console.log(b.symbols),(!b.symbols||b.symbols.length<1)&&(b.symbols={},c.makeSymbol()),a.clearStorage=function(){d.clearStorage()}}]),angular.module("symbolMapApp").directive("mayutextarea",["$rootScope",function(a){var b=function(b,c,d){function e(a,b,c){if(c=c||b,a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveEnd("character",c),d.moveStart("character",b),d.select()}else a.setSelectionRange&&(a.focus(),a.setSelectionRange(b,c))}var f=function(a){var b=0;if(document.selection){a.focus();var c=document.selection.createRange();c.moveStart("character",-a.value.length),b=c.text.length}else(a.selectionStart||"0"==a.selectionStart)&&(b=a.selectionStart);return b},g=function(){for(var a="",b="0123456789",c=0;7>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a};c.bind("keydown",function(c){var h,i,j,k=parseInt(d.workspace),l=a.workspace[k],m=a.symbols[l],n=parseInt(d.mayutextarea),o=m[n],p=document.getElementById("lineItem-"+k+"-"+n),q=n-1,r=m[q],s=document.getElementById("lineItem-"+k+"-"+q),t=n+1,u=m[t],v=document.getElementById("lineItem-"+k+"-"+t),w=f(p),x=p.value.length;return 13===c.keyCode&&c.shiftKey===!1?(h=angular.copy(m),c.preventDefault(),i=n+1,m.splice(i,0,{meta:{id:g()},tab:o.tab,media:{}}),w!==x&&(j=p.value.slice(w,x),console.log("CURRENTLINE",a.symbols[o.meta.id]),a.symbols[o.meta.id][0].media.text=p.value.slice(0,w)),a.$apply(),b.$emit("newIds",_.pluck(m,"_id"),k,j),document.getElementById("lineItem-"+k+"-"+i).focus(),!1):9===c.keyCode?(c.preventDefault(),c.shiftKey&&0!=o.tab?o.tab-=1:c.shiftKey||(o.tab+=1),b.$apply(),!1):37===c.keyCode&&c.shiftKey===!1&&0===w&&r?(c.preventDefault(),e(s,a.symbols[r._id].text.length),!1):38===c.keyCode&&c.shiftKey===!1&&r?(c.preventDefault(),e(s,w),!1):39===c.keyCode&&c.shiftKey===!1&&w===x&&u?(c.preventDefault(),e(v,0),!1):40===c.keyCode&&c.shiftKey===!1&&u?(c.preventDefault(),e(v,w),!1):void 0})};return{restrict:"A",link:{post:b}}}]);var caretPosition={get:function(a){var b=0;if(document.selection){a.focus();var c=document.selection.createRange();c.moveStart("character",-a.value.length),b=c.text.length}else(a.selectionStart||"0"==a.selectionStart)&&(b=a.selectionStart);return b},set:function(a,b){if(document.selection){a.focus();var c=document.selection.createRange();c.moveStart("character",-a.value.length),c.moveStart("character",b),c.moveEnd("character",0),c.select()}else(a.selectionStart||"0"==a.selectionStart)&&(a.selectionStart=b,a.selectionEnd=b,a.focus())}};angular.module("symbolMapApp").directive("symbollinemod",["$rootScope","symFlatModelTransforms","storage",function(a,b,c){var d=function(d,e,f){e.bind("keydown",function(e){var g=(parseInt(f.workspace),f.parentsymbolid),h=a.symbols[g],i=parseInt(f.lineindex),j=h[i],k=(j.meta.id,document.getElementById(g+"-"+i));if(i>0)var l=i-1,m=h[l],n=(m.meta.id,document.getElementById(g+"-"+l));if(i<h.length-1)var o=i+1,p=h[o],q=(p.meta.id,document.getElementById(g+"-"+o));var r=caretPosition.get(k),s=k.value.length;return 13===e.keyCode&&e.shiftKey===!1?(e.preventDefault(),b.addNewLine(g,i),document.getElementById(g+"-"+(i+1)).focus(),!1):9===e.keyCode?(e.preventDefault(),e.shiftKey&&0!=j.tab?j.tab-=1:e.shiftKey||(j.tab+=1),d.$apply(),!1):37===e.keyCode&&e.shiftKey===!1&&0===r&&m?(e.preventDefault(),textSelect(n,n.value.length),!1):38===e.keyCode&&e.shiftKey===!1&&m?(e.preventDefault(),textSelect(n,r),!1):39===e.keyCode&&e.shiftKey===!1&&r===s&&p?(e.preventDefault(),textSelect(q,0),!1):40===e.keyCode&&e.shiftKey===!1&&p?(e.preventDefault(),caretPosition.set(q,r),!1):(8===e.keyCode&&e.shiftKey===!0&&(0===i?b.deleteSymbol(g):(b.deleteLine(g,i),document.getElementById(g+"-"+(i-1)).focus())),83===e.keyCode&&e.metaKey===!0?(e.preventDefault(),c.put(),!1):void 0)})};return{restrict:"A",link:{post:d}}}]),angular.module("symbolMapApp").factory("symFlatToTree",function(){var a=42;return{someMethod:function(){return a}}}),angular.module("symbolMapApp").factory("symTreeToFlat",function(){var a=42;return{someMethod:function(){return a}}}),angular.module("symbolMapApp").factory("symFlatModelConstructor",["$rootScope","storage",function(a){function b(){for(var a="",b="0123456789",c=0;7>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}function c(){var c=b();return a.symbols[c]=[{meta:{id:c},tab:0,media:{text:""}}],e(),c}function d(a,b){return{meta:{id:a},tab:b,"â€¢":!1,"->":!0,"?":!0,"-":!1,priority:1}}function e(){for(var b in a.symbols)a.workspace.indexOf(b)<0&&a.workspace.push(b)}return{makeSymbol:c,makeLine:d,makeId:b,applyWorkspace:e}}]),angular.module("symbolMapApp").factory("symTreeModelConstructor",function(){var a=42;return{someMethod:function(){return a}}}),angular.module("symbolMapApp").factory("symFlatModelTransforms",["$rootScope","symFlatModelConstructor",function(a,b){function c(c,d){console.groupCollapsed("Add New Line");var e,f,g=a.symbols[c||b.makeId()],h=g[d||0],c=b.makeSymbol();f=Object.create(g),console.log("SYMBOLID",c,a.symbols[c]),e=d+1,g.splice(e,0,b.makeLine(c,h.tab)),console.log(g),a.$apply(),console.groupEnd()}function d(b,c){console.groupCollapsed("Delete Line");{var d=a.symbols[b];d[c]}d.splice(c,1),a.$apply(),console.groupEnd()}function e(b){delete a.symbols[b]}a.symbols;return{addNewLine:c,deleteLine:d,deleteSymbol:e}}]),angular.module("symbolMapApp").factory("symTreeModelTransforms",function(){var a=42;return{someMethod:function(){return a}}}),angular.module("symbolMapApp").factory("storage",["$rootScope",function(a){function b(){e.put()}function c(){return e.get()}function d(){e.clearStorage()}var e=Object.create({});return e.id="mvpSymbols",e.get=function(){return console.log("GET",this),JSON.parse(localStorage.getItem(this.id)||"[]")},e.put=function(){localStorage.setItem(this.id,JSON.stringify(a.symbols))},e.clearStorage=function(){console.log("clear",this.id),localStorage.removeItem(this.id)},{get:c,put:b,clearStorage:d}}]);